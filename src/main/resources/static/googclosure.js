
// A small snippet from the Google closure-libary file crypt.js
//   Modified: namespace changed 4/26/2020
// See https://github.com/google/closure-library for complete library
// Copyright notice for the stringToUtf8ByteArray function:
// Copyright 2008 The Closure Library Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * Converts a JS string to a UTF-8 "byte" array.
 * @param {string} str 16-bit unicode string.
 * @return {!Array<number>} UTF-8 byte array.
 */
stringToUtf8ByteArray = function(str) {
    // TODO(user): Use native implementations if/when available
    var out = [], p = 0;
    for (var i = 0; i < str.length; i++) {
	var c = str.charCodeAt(i);
	if (c < 128) {
	    out[p++] = c;
	} else if (c < 2048) {
	    out[p++] = (c >> 6) | 192;
	    out[p++] = (c & 63) | 128;
	} else if (
		   ((c & 0xFC00) == 0xD800) && (i + 1) < str.length &&
		   ((str.charCodeAt(i + 1) & 0xFC00) == 0xDC00)) {
	    // Surrogate Pair
	    c = 0x10000 + ((c & 0x03FF) << 10) + (str.charCodeAt(++i) & 0x03FF);
	    out[p++] = (c >> 18) | 240;
	    out[p++] = ((c >> 12) & 63) | 128;
	    out[p++] = ((c >> 6) & 63) | 128;
	    out[p++] = (c & 63) | 128;
	} else {
	    out[p++] = (c >> 12) | 224;
	    out[p++] = ((c >> 6) & 63) | 128;
	    out[p++] = (c & 63) | 128;
	}
    }
    return out;
};
